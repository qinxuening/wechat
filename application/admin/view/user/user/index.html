{extend name="layout/default" /}
{block name="content"}

<!--会员发送短信弹框begin-->
<div class="body-form selectMemberToSendSms auto-height-table" style="display: none">
    <div class="layui-form">
        <div class="layui-row">
            <table class="layui-hide" id="table_black" lay-filter="table_black" table-reload-id="tableReload"></table>
        </div>
    </div>
</div>
<!--会员发送短信弹框end-->
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12 webody body-overflow">
            <div class="layui-row yty-bck">
            <div class="layui-col-12">
                <div class="searchbody">
                </div>
            </div>
            </div>

            <div class="layui-card">
                <div class="layui-card-body">
                    <table class="layui-hide" id="memberList" lay-filter="memberList" table-reload-id="tableReload" lay-size="sm"></table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!--头工具栏-->
<!--{:build_toolbar('toolbar',['refresh', 'add', 'del', 'export'])}-->

<!------------------------表格头工具栏begin------------------------->
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border" lay-event="addBlack"><i class="fa fa-plus"></i> 加入黑名单</a>
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border" lay-event="sendSearchResultSms"><i class="fa fa-envelope-o"></i> 选择会员发送短信</a>
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border" lay-event="addMember"><i class="fa fa-plus"></i> 新增联系人</a>
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border" lay-event="importMemberInfo"><i class="fa fa-file-text-o"></i> 导入会员信息</a>
</script>
<!-------------------------表格头工具栏end---------------------------->

<!--状态-->
<!--<script type="text/html" id="switchStatus">-->
    <!--<input type="checkbox" name="status" value="{{d.status}}" lay-skin="switch" lay-text="激活|禁用" lay-filter="ruleStatus" {{ d.status == 1 ? 'checked' : '' }}>-->
<!--</script>-->

<!--状态-->
<!--<script type="text/html" id="switchIsmenu">-->
    <!--<input type="checkbox" name="ismenu" value="{{d.ismenu}}" lay-skin="switch" lay-text="是|否" lay-filter="ruleIsmenu" {{ d.ismenu == 1 ? 'checked' : '' }}>-->
<!--</script>-->

<!--操作-->
{:build_actionbar('actionbar',['edit', 'del'])}
{/block}

{block name="script"}
<script>
    layui.config({
        base: "__STATIC__/", //静态资源所在路径
//        skin: 'layui-layer-we'
        version:true,
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index','table','element','form','authtree','we','weTable','formSearch'], function(){
        var admin = layui.admin
            ,element = layui.element
            ,table = layui.table
            ,layer = layui.layer
            ,we = layui.we
            ,form = layui.form
            ,weTable = layui.weTable
            ,formSearch = layui.formSearch
            ,toastr = layui.toastr;

        layer.load(0, {shade: false});
        var tableCommon = {
            elem: '#memberList'
            ,formId:'search_form'
            ,method:'post'
            ,url:"{:url('Admin/user.user/index')}"
            ,id : 'tableReload'
            ,skin:'line'
            ,toolbar : '#toolbar'
            ,data:{'Search':"{:__('Search')}",'Reset':"{:__('Reset')}"}
//            ,limit : 4
            ,loading:true
            ,limit:10
            ,defaultToolbar: ['filter']//'filter', 'print', 'exports'
            ,search: true
            ,cols: [[
                {type:'checkbox', fixed: 'left',}
                ,{field:'id', title: 'ID', sort: true, excel_width:15,hide:false}
                ,{field:'yxName', title: "云信昵称", sort: true, excel_width:15, searchList:{type:'input',operate:'LIKE'}, minWidth: 120}
                ,{field:'userName', title: "姓名", excel_width:15, searchList:{type:'input',operate:'LIKE'}, minWidth: 120}
                ,{field:'tradeAmount', title: "交易金额", excel_width:15, minWidth: 120}
                ,{field:'tradeCount', title: "交易笔数", excel_width:15, minWidth: 120}
                ,{field:'memberLevel', title: "会员等级", excel_width:15, minWidth: 120}
                ,{field:'area', title: "区域", excel_width:15, searchList:{type:'select',data:{"北京":"北京","天津":"天津","上海":"上海"},'operate':'='}, minWidth: 120}
                ,{field:'phone', title: "手机号", excel_width:15, searchList:{type:'input',operate:'LIKE'}, minWidth: 130}
                ,{field:'email', title: "邮箱", excel_width:15, minWidth: 120}
                ,{field:'lastTradingTime', title: "最后交易时间", excel_width:15, minWidth: 140}
                ,{fixed: 'right', title:"{:__('Operate')}", toolbar: '#actionbar', width:160}
            ]]
            ,page: {
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                ,all:"{:__('Total')}"
                ,item:"{:__('Item')}"
                ,confirm:"{:__('Confirm')}"
                ,page:"{:__('Page')}"
                ,ipage:"{:__('IPage')}"
                ,to:"{:__('To')}"
                ,first: "{:__('First')}"
                ,last: "{:__('Last')}"
                ,prev: "{:__('Previous')}"
                ,next: "{:__('Next')}"
            }
            ,done: function(res, curr, count){
//                if(res.status == 'success') {
                    layer.closeAll();
//                }
            }
            ,error:function () {
                layer.closeAll();
            }
        }

        table.render(tableCommon); //数据表格初始化
        formSearch.api.init(tableCommon); //搜索初始化

        /**
         * 表格初始化
         */
        weTable.api.init({
            table : "memberList",
            is_display:false,
            tableid : "tableReload",
            form:$("form#search_form"),
            tableCommon: tableCommon,
            extend : {
                "add_url": "{:url('admin/user.user/edit',['nav_id'=>input('nav_id'),'nav_pid'=>input('nav_pid')],false)}",
                "edit_url": "{:url('admin/user.user/edit',['nav_id'=>input('nav_id'),'nav_pid'=>input('nav_pid')],false)}&ids=",
                "view_url": "{:url('admin/user.user/view',['nav_id'=>input('nav_id'),'nav_pid'=>input('nav_pid')],false)}&ids=",
                "del_url": "{:url('admin/user.user/del',['nav_id'=>input('nav_id'),'nav_pid'=>input('nav_pid')],false)}",
                "export_url" : "{:url('admin/user.user/index',['id'=>input('nav_id'),'nav_pid'=>input('nav_pid')],false)}"
            }
        });

        /**
         * 绑定监听事件
         * */
        weTable.api.bindevent();
        formSearch.api.searchForm($("form#search_form"));

        //表头工具栏事件
        table.on('toolbar(memberList)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id);
            var data = checkStatus.data;
            var idsArr = [];
            console.log(data);
            $.each(data,function (index, value) {
                idsArr.push(value.id);
            });
            if(obj.event == 'addBlack') {
                if(data != "") {
                    layer.confirm('请确定是否加入黑名单？',{
                        title:'温馨提示',
                    }, function(index){
                        //对接后台拉黑接口
                        we.api.ajax({"url":"","data":{'ids':idsArr.join(',')},'tableid':"tableReload",'action':'del'});
                        layer.close(index);
                    });
                } else {
                    toastr.error('没有选择数据');
                }
            } else if(obj.event == 'sendSearchResultSms') {
                if(data != "") {
                    short_sms_layer_index = we.api.open_current_page_layer($(".selectMemberToSendSms"),'选则订单发送',{zIndex:19891016
                    },['80%' , '80%']);
                }else{
                    toastr.error('没有选择数据');
                }
            }


        })
    });
</script>
</body>
</html>
{/block}