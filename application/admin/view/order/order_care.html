{extend name="layout/default" /}
{block name="content"}
<body>
<div class="layui-fluid main-task">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12 webody body-overflow">
            <div class="layui-card margin_buttom0 padding20_10 overflow-y">
                <!--<div class="layui-card-header yty-card-header"><span class="sm-st-icon-left shop-info"><i class="fa  fa-ellipsis-v"></i></span>所有通知环节</div>-->
                <!----------------------------------通知关怀流程图标begin------------------------------->
                <div class="layui-card-body">
                    <ul class="notice_ulstyle">
                        <li><a href=""><p class="img img1"></p>下单关怀</a><span class="flowLineBottom"><img src="__STATIC__/style/images/flowLineBottom.png" alt=""></span><a href=""><p class="img"></p>货到付款</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>常规催付</a><span class="flowLineBottom"><img src="__STATIC__/style/images/flowLineBottom.png" alt=""></span><a href=""><p class="img"></p>预售催付</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>二次催付</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>付款提醒</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>发货提醒</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>同城提醒</a><span class="flowLineBottom"><img src="__STATIC__/style/images/flowLineBottom.png" alt=""></span><a href=""><p class="img"></p>迟发提醒</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>派件提醒</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>签收提醒</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>评价提醒</a><span class="flowLineBottom"><img src="__STATIC__/style/images/flowLineBottom.png" alt=""></span><a href=""><p class="img"></p>退款关怀</a></li>
                        <li class="flowLine"></li>
                        <li  style="width: 60px !important;"><a href=""><p class="img"></p>好评感谢</a><span class="flowLineBottom"><img src="__STATIC__/style/images/flowLineBottom.png" alt=""></span><a href=""><p class="img"></p>中差评安抚</a></li>
                        <li class="flowLine"></li>
                        <li><a href=""><p class="img"></p>售后关怀</a></li>
                    </ul>
                </div>
                <!----------------------------------通知关怀流程图标end--------------------------------->
            </div>

            <div class="layui-form yty-tab">
                <div class="layui-tab" lay-filter="short-href-tab">
                    <ul class="layui-tab-title tabpage">
                        <li class="layui-this" lay-id="common_link"><a href="#">下单提醒设置</a></li>
                        <li><a href="#">查看发送记录</a></li>
                    </ul>
                    <div class="layui-tab-content" >
                        <!------------------------------------下单提醒设置begin---------------------------->
                        <div class="layui-tab-item layui-show">
                            <div class="layui-row yty-bck">
                                <div class="layui-col-12">
                                    <!----------------------------------表格查询条件begin------------------------------->
                                    <div class="searchbody">

                                    </div>
                                    <!-----------------------------------表格查询条件end--------------------------------->
                                </div>
                            </div>

                            <div class="layui-card">
                                <div class="layui-card-body layui-card-body-padding">
                                    <!-----------------------------------------------订单查询结果begin----------------------->
                                    <table class="layui-hide" id="order_care_data_list" lay-filter="order_care_data_list" table-reload-id="tableReload" lay-size="sm"></table>
                                    <!----------------------------------------------订单查询结果end-------------------------->
                                </div>
                            </div>

                        </div>
                        <!------------------------------------下单提醒设置end----------------------------->

                        <!------------------------------------查看发送记录begin---------------------------->
                        <div class="layui-tab-item">
                            <div class="layui-row yty-bck">
                                <div class="layui-col-12">
                                    <!----------------------------------表格查询条件begin------------------------------->
                                    <div class="searchbody2 searchBodyCommon">

                                    </div>
                                    <!-----------------------------------表格查询条件end--------------------------------->
                                </div>
                            </div>

                            <div class="layui-card">
                                <div class="layui-card-body layui-card-body-padding">
                                    <!-----------------------------------------------订单查询结果begin----------------------->
                                    <table class="layui-hide" id="sendSmsRecordData" lay-filter="sendSmsRecordData" table-reload-id="tableReload2" lay-size="sm"></table>
                                    <!----------------------------------------------订单查询结果end-------------------------->
                                </div>
                            </div>
                        </div>
                        <!------------------------------------查看发送记录begin---------------------------->

                    </div>
                </div>
            </div>


        </div>
    </div>
</div>
{include file="order/task_add"/}
<!--</div>-->

<!-----------------------------下单提醒设置表格头部按钮begin---------------------------->
<script type="text/html" id="toolbar">
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border yty-btn" lay-event="add_task"><i class="fa fa-plus"></i> 新建任务</a>
</script>
<!-----------------------------下单提醒设置表格头部按钮end----------------------------->

<!------------------------------下单提醒设置任务状态begin--------------------------->
<script type="text/html" id="task_status">
    <input type="checkbox" name="task_status" value="{{d.ismenu}}" lay-skin="switch" lay-text="开启|关闭" lay-filter="task_status" {{ d.ismenu == 1 ? 'checked' : '' }}>
</script>
<!------------------------------下单提醒设置任务状态end--------------------------->


<!-----------------------------查看发送记录表格头部按钮begin---------------------------->
<script type="text/html" id="toolbar2">
    <a class="layui-btn layui-btn-sm layui-btn-primary btn-primary-border yty-btn" lay-event="export"><i class="fa fa-file-o"></i> 导出</a>
</script>
<!-----------------------------查看发送记录表格头部按钮end----------------------------->

<!--操作-->
{:build_actionbar('actionbar',['edit', 'del'])}
<!--<script type="text/html" id="barDemo">-->
<!--<a class="layui-btn layui-btn-xs layui-btn-view" lay-event="view">查看</a>-->
<!--<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>-->
<!--<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>-->
<!--</script>-->
{/block}

{block name="script"}
<script>
    layui.config({
        base: "__STATIC__/", //静态资源所在路径
        skin: 'layui-layer-we',
        version:true,
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index','table','element','form','authtree','we','weTable','laydate','formValidator','formSearch','sms_modal_init'], function(){
        var admin = layui.admin
            ,element = layui.element
            ,table = layui.table
            ,layer = layui.layer
            ,laydate = layui.laydate
            ,we = layui.we
            ,sms_modal_init = layui.sms_modal_init
            ,form = layui.form
            ,weTable = layui.weTable
            ,formSearch = layui.formSearch
            ,formValidator = layui.formValidator
            ,toastr = layui.toastr;

        /*********************下单提醒设置表格初始化begin**************************/
        layer.load(0, {shade: false});
        var tableCommon = {
            elem: '#order_care_data_list'
            ,formId:'search_form'  //查询form表单id
            ,searchbody:'searchbody'
            ,method:'post'
            ,url:"/sms_data.json" //对接请求后台数据
            ,id : 'tableReload'
            ,skin:'line'
            ,toolbar : '#toolbar'
            ,data:{'Search':"{:__('Search')}",'Reset':"{:__('Reset')}"}
            ,loading:true
            ,limit:10
            ,defaultToolbar: ['']//'filter', 'print', 'exports'
            ,search: true
            ,cols: [[
                {type:'checkbox', fixed: 'left',hide:true}
                ,{field:'id', title: 'ID', sort: true, excel_width:15}
                ,{field:'task_name', title: "任务名称", excel_width:15, minWidth: 120, searchList:{type:'input',operate:'LIKE'},}
                ,{field:'task_type', title: "任务类型", excel_width:15, searchList:{type:'select',data:{"1":"持续开启","0":"固定时段"},'operate':'='}, minWidth: 120}
                ,{field:'task_status', title: "任务状态", excel_width:15,templet: '#task_status', searchList:{type:'select',data:{"1":"开启","0":"关闭"},'operate':'='}, minWidth: 120}
                ,{field:'send_content', title:  "发送内容", excel_width:15, minWidth: 200}
                ,{field:'create_time', title: "创建时间", excel_width:15, searchList:{type:'input',event:'date',operate: 'RANGE'}, minWidth: 120}
                ,{field:'update_time', title: "更新时间", excel_width:15, searchList:{type:'input',event:'date',operate: 'RANGE'}, minWidth: 120}
                ,{field:'priority ', title: "优先级", excel_width:15, minWidth: 100}
                ,{fixed: 'right', title:"{:__('Operate')}", toolbar: '#actionbar', width:220}
            ]]
            ,page: {
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                ,all:"{:__('Total')}"
                ,item:"{:__('Item')}"
                ,confirm:"{:__('Confirm')}"
                ,page:"{:__('Page')}"
                ,ipage:"{:__('IPage')}"
                ,to:"{:__('To')}"
                ,first: "{:__('First')}"
                ,last: "{:__('Last')}"
                ,prev: "{:__('Previous')}"
                ,next: "{:__('Next')}"
            }
            ,done: function(res, curr, count){
                if(res.status == 'success') {
                    layer.closeAll();
                }
            }
        }
        table.render(tableCommon); //数据表格初始化
        formSearch.api.init(tableCommon); //表单查询初始化
        /*********************下单提醒设置表格初始化end**************************/

        /**
         * 单提醒设置表单查询查询操作
         * */
        formSearch.api.searchForm($("form#search_form"));

        //单提醒设置表头工具栏事件
        table.on('toolbar(order_care_data_list)', function(obj){
            console.log(obj.event);
            if(obj.event == 'add_task') {
                $('.main-task').hide();
                $('.sms-common').slideDown(200);
//                var url = "{:url('admin/order/task_add')}"
//                we.api.open(url,'下单关怀 > 新建任务',{zIndex:19891017,shade: 0.4},['98%' , '80%']);
            }
        })

        //单提醒设置表格工具栏事件
        table.on('tool(order_care_data_list)', function(obj){
            console.log(obj.event);
            if(obj.event == 'edit') {
                $('.main-task').hide();
                $('.sms-common').slideDown(200);
//                var url = "{:url('admin/order/task_add')}"; //对接后台编辑url
//                we.api.open(url,'下单关怀 > 编辑任务',{zIndex:19891017,shade: 0.4},['98%' , '80%']);
            } else {
                layer.confirm('请确定是否删除？',{
                    title:'温馨提示',
                }, function(index){
                    var url = ""; //对接后台删除url
                    we.api.ajax({"url":url,"data":{'ids':""},'tableid':'tableReload','action':'del'});
                    layer.close(index);
                });
            }
        })



        /*********************查看发送记录begin**************************/
        var tableCommon2 = {
            elem: '#sendSmsRecordData'
            ,formId:'search_form_record'  //查询form表单id
            ,searchbody:'searchbody2'
            ,method:'post'
            ,url:"/sms_data.json" //对接请求后台数据
            ,id : 'tableReload2'
            ,skin:'line'
            ,toolbar : '#toolbar2'
            ,data:{'Search':"{:__('Search')}",'Reset':"{:__('Reset')}"}
            ,loading:true
            ,limit:10
            ,defaultToolbar: ['']//'filter', 'print', 'exports'
            ,search: true
            ,cols: [[
                {type:'checkbox', fixed: 'left',hide:true}
                ,{field:'id', title: 'ID', sort: true, excel_width:15}
                ,{field:'phone', title: "手机号码", excel_width:15, minWidth: 120, searchList:{type:'input',operate:'LIKE'}}
                ,{field:'smsContent', title: "短信内容", excel_width:15, minWidth: 120}
                ,{field:'taskName', title: "任务名称", excel_width:15, minWidth: 120,hide:true, searchList:{type:'input',operate:'LIKE'}}
                ,{field:'smsChannel', title: "短信通道", excel_width:15, minWidth: 120}
                ,{field:'buyerName', title:  "买家昵称", excel_width:15, minWidth: 200, searchList:{type:'input',operate:'LIKE'}}
                ,{field:'sendStatus', title: "发送状态", excel_width:15, searchList:{type:'select',data:{"1":"成功","0":"失败"},'operate':'='}, minWidth: 120}
                ,{field:'actualDeductionCount', title: "实际扣费（条）", excel_width:15, minWidth: 130}
                ,{field:'sendTime ', title: "发送时间", excel_width:15, minWidth: 100, searchList:{type:'input',event:'date',operate: 'RANGE'}}
            ]]
            ,page: {
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip']
                ,all:"{:__('Total')}"
                ,item:"{:__('Item')}"
                ,confirm:"{:__('Confirm')}"
                ,page:"{:__('Page')}"
                ,ipage:"{:__('IPage')}"
                ,to:"{:__('To')}"
                ,first: "{:__('First')}"
                ,last: "{:__('Last')}"
                ,prev: "{:__('Previous')}"
                ,next: "{:__('Next')}"
            }
            ,done: function(res, curr, count){
                if(res.status == 'success') {
                    layer.closeAll();
                }
            }
        }
        table.render(tableCommon2); //数据表格初始化
        formSearch.api.init(tableCommon2); //表单查询初始化

        formSearch.api.searchForm($("form#search_form_record")); //搜索操作初始化

        /***
         * 表头事件（导出）
         * */
        weTable.api.init({
            table : "sendSmsRecordData",
            is_display:false,
            tableid : "tableReload2",
            form:$("form#search_form_record"),
            tableCommon: tableCommon2,
            extend : {
                "export_url" : ""
            }
        });
        weTable.api.bindevent();
        /*********************查看发送记录end****************************/


        /****************************************3个步奏公共模块begin***********************************/

        /******************************时间初始化begin*****************************/
        laydate.render({
            elem: '#day_hour_start' //指定元素
            ,type: 'time'
            // ,format:'H'
            ,value:'09:00:00'
        });
        laydate.render({
            elem: '#day_hour_end' //指定元素
            ,type: 'time'
            // ,format:'H'
            ,value:'21:00:00'
        });

        laydate.render({
            elem: '#siesta_hour_start' //指定元素
            ,type: 'time'
            // ,format:'H'
            ,value:'12:00:00'
        });
        laydate.render({
            elem: '#siesta_hour_end' //指定元素
            ,type: 'time'
            // ,format:'H'
            ,value:'13:00:00'
        });

        laydate.render({
            elem: '#task_time_start' //指定元素
            ,type: 'date'
            // ,format:'H'
        });
        laydate.render({
            elem: '#task_time_end' //指定元素
            ,type: 'date'
            // ,format:'H'
        });
        /******************************时间初始化begin*****************************/


        /**
         *
         * 点击指定时间
         * */
        form.on('radio(date_switch)', function(data){
            if(data.value == 0){
                $(".task_time").show()
            }else(
                $(".task_time").hide()
            )
        });


        /**
         * 屏蔽标旗点击切换
         */
        $("body").on("click","ul li",function (){
            if($(this).hasClass('checkbox-active')) {
                $(this).removeClass('checkbox-active');
            } else {
                $(this).addClass('checkbox-active')
            }
        });


        /**
         * 设置黑名单弹框
         * */
        $("body").on("click",".set_black",function (){
            var tableCommon = {
                elem: '#table_black'
                ,url:"/sms_data.json" //对接请求后台数据
                // ,data:"./sms_data.json" //测试数据
                ,id : 'tableReload'
                ,skin:'line'
                ,limit:10
                ,defaultToolbar: ['filter']
                ,toolbar : '#set_black_toolbar'
                ,data:{'Search':"{:__('Search')}",'Reset':"{:__('Reset')}"}
                ,search: false
                ,cols: [[
                    {type:'checkbox', fixed: 'left', hide:true}
                    ,{field:'id', title: 'id', hide:true}
                    ,{field:'uid_name', title: '云信/手机号码'}
                    ,{field:'black_type', title: '黑名单类型'}
                    ,{field:'add_time', title: '添加时间'}
                    ,{field:'source', title: '添加来源'}
                    ,{fixed: 'right', title:'操作', toolbar: '#set_black_actionbar', width:250}
                ]]
                ,page: {
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    ,first: false //不显示首页
                    ,last: false //不显示尾页

                }
                ,where: {filter:JSON.stringify(formSearch.api.getFormJson($(form)))}   //搜索条件
                ,done: function(res, curr, count){
                    if(res.status == 'success') {
                        // layer.closeAll();
                    }
                }
            };

            table.render(tableCommon); //数据表格初始化
            set_black_layer_index = we.api.open_current_page_layer($(".black-module-layer"),'设置黑名单',{zIndex:19891016
            },['80%' , '80%']);

            if(init_m == 0) {
                formSearch.api.searchForm($("form#form-set-black"));
            }
        })

        /**
         *设置黑名单头部操作
         * */
        table.on('toolbar(table_black)', function(obj){
            console.log(obj.event);
            if(obj.event == 'add_black'){
                add_black_layer_index = we.api.open_current_page_layer($(".add-black-layer"),'添加黑名单',{zIndex:19891017
                },['40%' , '60%']);
            }
        });

        /**
         * sms_record短信测试发送记录
         * */
        $("body").on("click",".sms_record",function (){
            var url = "{:url('admin/order/sms_record')}"
            we.api.open(url,'短信测试发送记录');
        })

        /**
         * 短信modal初始化
         * */
        sms_modal_init.init();

        /*****************************执行步骤begin************************************/
        /**
         *点击第一步下一步
         */
        $("body").on("click",".next-step",function (){
            $(".step-first").hide();
            $(".step-second").show();
            $(".step-two-msg").addClass('step-active');
            $(".step-tow-number").addClass('step-number-active');
        });

        /**
         * 点击第二步上一步
         */
        $("body").on("click",".pre-step",function (){
            $(".step-first").show();
            $(".step-second").hide();
            $(".step-two-msg").removeClass('step-active');
            $(".step-tow-number").removeClass('step-number-active');
        });

        /**
         * 点击第二步下一步
         */
        $("body").on("click",".next-step-thrid",function (){
            $(".step-second").hide();
            $(".step-third").show();
            $(".step-three-msg").addClass('step-active');
            $(".step-three-number").addClass('step-number-active');
        });

        /**
         * 点击第三步上一步
         */
        $("body").on("click",".pre-step-thrid",function (){
            $(".step-second").show();
            $(".step-third").hide();
            $(".step-three-msg").removeClass('step-active');
            $(".step-three-number").removeClass('step-number-active');
        });

        /**
         * 点击取消
         * 关掉layer弹层
         */
        $("body").on("click",".cancle",function (){
//            var index = parent.layer.getFrameIndex(window.name);
//            parent.layer.close(index);
            $(".step-second").hide();
            $(".step-two-msg").removeClass('step-active');
            $(".step-tow-number").removeClass('step-number-active');
            $(".step-third").hide();
            $(".step-three-msg").removeClass('step-active');
            $(".step-three-number").removeClass('step-number-active');
            $(".step-first").show();
            $('.main-task').slideDown(100);
            $('.sms-common').hide();
        });
        /*****************************执行步骤end************************************/

        /**
         * 绑定表单事件
         */
        formValidator.api.bindevent($("form#task_form_data"));
        /****************************************3个步奏公共模块begin***********************************/
    });
</script>
</body>
</html>
{/block}